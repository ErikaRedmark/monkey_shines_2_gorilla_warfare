#include	"globals extern.h"/* Copy a Pascal-string */void CopyString(Str255 dest, Str255 src){	short i;	for (i=0; i <= src[0]; i++)	{		if (i < 32) dest[i] = src[i];		else dest[0] = 32;	}} /* CopyString *//* 'score' might be a high score. Find out which score it is *//* and (later) will prompt for the player' name */void HandleHighScore( long score ){	short i, rank;	// check if the current score is a high score	// if not then return		if (score <= (*theScoreHandle)->aSavedHighScore[9]) return;	// score is a high score, so decide which one			for (i = 8; i >= 0; i--)	{		if (score <= (*theScoreHandle)->aSavedHighScore[i]) break;	}		if (score > (*theScoreHandle)->aSavedHighScore[0]) rank = 0;	else rank = i + 1;	// move all other scores down one place to make room		for (i = 9; i > rank; i--)	{		(*theScoreHandle)->aSavedHighScore[i] = (*theScoreHandle)->aSavedHighScore[i - 1];		CopyString((**theScoreHandle).aName[i], (**theScoreHandle).aName[i - 1]);	}	(*theScoreHandle)->aSavedHighScore[rank] = score;	// now want to get the name of the player	CopyString((**theScoreHandle).aName[rank], "\p              ");	HighScoreEventLoop(true, rank);	// mark the high score resource as changed so that system will write it out	UpdatePreferences();}void	HighScoreEventLoop(Boolean gettingScore, short rank){	Boolean waitedLongEnough = false;	long startTime;	DrawHighScoreScreen(rank);	CustomShowCursor();	FlushEvents(everyEvent, 0);	if (rank < 10)	PlayASound(sndHighScore);	if (gettingScore)	{		DialogPtr		theDialog;		Boolean			dialogDone;		Handle			nameHandle, okItemHandle;		short			itemType, itemHit;		Rect			itemRect;		Str255			nameText;		StringHandle	theStringHandle;		OSErr			theError;		short			theVolume;		long			theDirectory;		FSSpec			preferencesFile;		short			prefsFileNumber, wasResFile;		wasResFile = CurResFile();		theError = FindFolder(kOnSystemDisk, 'sprf', kDontCreateFolder, &theVolume, &theDirectory);		if (theError != noErr) theError = FindFolder(kOnSystemDisk, kPreferencesFolderType,							kDontCreateFolder, &theVolume, &theDirectory);		if (theError != noErr) theError = FindFolder(kOnSystemDisk, kSystemFolderType,							kDontCreateFolder, &theVolume, &theDirectory);		// if we didn't find a preferences folder on the system		// disk, look for a system folder. This MUST exist		#ifdef	DEMO		theError = FSMakeFSSpec(theVolume, theDirectory, "\pGorilla Warfare Demo Prefs",									&preferencesFile);		#else		theError = FSMakeFSSpec(theVolume, theDirectory, "\pGorilla Warfare Preferences",									&preferencesFile);		#endif		prefsFileNumber = FSpOpenResFile(&preferencesFile, fsCurPerm);		theStringHandle = (StringHandle)Get1Resource('STR ', 128);		if ((theStringHandle == nil) || (ResError() != noErr))					FatalError("Error loading high score string", true);		UseResFile(theFileStuff.GWDataFileNumber);		theDialog = GetNewDialog(129, nil, (WindowPtr)-1L);		SetPort(theDialog);		DrawDialog(theDialog);		BeginUpdate(theDialog);	    EndUpdate(theDialog);		FlushEvents(everyEvent,0);		ShowWindow(theDialog);		SetGWorld((CGrafPort *)theDialog, GetMainDevice());		SetDialogDefaultItem(theDialog, ok);		SetDialogTracksCursor(theDialog, true);				GetDialogItem(theDialog, 2, &itemType, &nameHandle, &itemRect);		GetDialogItem(theDialog, ok, &itemType, &okItemHandle, &itemRect);		dialogDone = false;		SetDialogItemText(nameHandle, *theStringHandle);				UseResFile(theFileStuff.applicationFile);		SelectDialogItemText(theDialog, 2, 0, 32768);				while (!dialogDone)		{			GetDialogItemText(nameHandle, nameText);						if (nameText[0] > 32)			{				nameText[0] = 32;				SetDialogItemText(nameHandle, nameText);				PlayASound(sndObjectShield);			}									CopyString((**theScoreHandle).aName[rank], nameText);												HiliteControl((ControlHandle)okItemHandle, 0);												ModalDialog(nil, &itemHit);												switch (itemHit)			{				case ok:					dialogDone = true;					break;			}		}				SetString(theStringHandle, nameText);		ChangedResource((Handle)theStringHandle);		UpdateResFile(prefsFileNumber);		FlushVol(nil, theVolume);		CloseResFile(prefsFileNumber);		ReleaseResource((Handle)theStringHandle);				DisposeDialog(theDialog);		SetGWorld(&theUserInterface.myCWindowRecord.port, GetMainDevice());			PlayASound(sndHighScoreApplause);		UseResFile(wasResFile);	}	SetCCursor(theUserInterface.myCursor);	CustomHideCursor();	DrawHighScoreScreen(rank);	startTime = TickCount();	// always wait at least 3 seconds, to allow sounds to finish playing	GWDelay(180, 1800, true);}void	ClearHighScores( void ){	short i;	for (i = 0; i < 10; i++)	{		(*theScoreHandle)->aSavedHighScore[i] = 1000 * (10 - i);		CopyString((**theScoreHandle).aName[i], "\pDarwin         ");	}}void	DrawHighScoreScreen(short blueName){	Str255 tempString;	short i, oldFile;	RGBColor	marksRed, marksBlue;	PicHandle tempPict;		marksRed.red = 63232;	marksRed.blue = 4096;	marksRed.green = 10496;	marksBlue.red = 18944;	marksBlue.blue = 37888;	marksBlue.green = 18944;	// draw high score screen in a GWorld	SetGWorld(theGWorlds.screenGWorld, nil);	oldFile = CurResFile();	UseResFile(theFileStuff.GWDataFileNumber);	tempPict = GetPicture(4000);	if (tempPict == nil) FatalError("Error loading PICT 4000", true);	DrawPicture(tempPict, &(theGWorlds.screenGWorld->portRect));	ReleaseResource((Handle)tempPict);	UseResFile(oldFile);		TextFace(bold + extend);		for (i = 0; i < 10; i++)	{		if (i == blueName)	RGBForeColor(&marksBlue);		else RGBForeColor(&marksRed);		MoveTo(100, 150 + (30 * i));		DrawString((*theScoreHandle)->aName[i]);				NumToString((*theScoreHandle)->aSavedHighScore[i], tempString);		MoveTo(540 - StringWidth(tempString), 150 + (30 * i));		DrawString(tempString);	}	// restore the drawing port		SetGWorld(&theUserInterface.myCWindowRecord.port, GetMainDevice());		// CopyBits the high score screen to the screen 								CopyBits( &((GrafPtr)theGWorlds.screenGWorld)->portBits, &((GrafPtr)(&theUserInterface.myCWindowRecord.port))->portBits, 			&theGWorlds.screenGWorld->portRect, &theGWorlds.screenGWorld->portRect, 			srcCopy, ( RgnHandle )0L );	ForeColor(blackColor);}