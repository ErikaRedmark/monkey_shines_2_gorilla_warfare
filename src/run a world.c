#include "globals extern.h"short	RunAWorld(void){	unsigned long	timer, timer2;	short			result, whichDoor;	Boolean			done;#ifndef DEMO	PicHandle		tempPict;	Rect			tempRect;#else	if (hackedOne | hackedTwo | hackedThree) HackedCopy();#endif	HandleCutScene();	timer = TickCount();#ifndef DEMO	HackCheckTwo();	CheckRegistrationTwo();#endif		LoadWorldData();	StartGameMusic();	timer2 = TickCount();	if (timer > timer2 - 300) GWDelay(0, 300 - (timer2 - timer), true);		DrawInterfaceBar();		// now start the fun		// changed - define the starting position by door, not by room, so that we start at door zero	// and let "RunAWorld" work out where this door is.		whichDoor = 0;	roomLoaded = -1;	// no room currently loaded	done = false;		#ifndef DEMO		if (!theFileStuff.saveFileInUse) player.gDead = true; // force initialisation of all bits	#else		player.gDead = true;	#endif	while (!done)	{		result = RunARoom(whichDoor);		if (result == 999) done = true;		else if (result == 1001) done = true;		else if (result == 32767) done = true;		else whichDoor = result;	}		StopGameMusic();		DisposeWorldData();		#ifndef DEMO		if (result == 1001)		{			Handle tempSound;			UseResFile(theFileStuff.worldFile);			tempPict = GetPicture(201);			if (tempPict == nil) FatalError("Error loading PICT 201", true);			SetRect(&tempRect, 0, 0, 640, 480);			SetGWorld(&theUserInterface.myCWindowRecord.port, GetMainDevice());			DrawPicture(tempPict, &tempRect);			UseResFile(theFileStuff.GWDataFileNumber); 			tempSound = Get1Resource('snd ', 1001);			SndPlay(theAudioStuff.beanieChannel,(SndListHandle)tempSound,true);			ReleaseResource(tempSound);						ReleaseResource((Handle)tempPict);			GWDelay(360, 360, true);		}	#endif		UseResFile(theFileStuff.applicationFile);		if (result == 999) return 0;	// game over	else if (result == 1001) return 1;	// finished world	else if (result == 32767) return 2;	return 0;}void	HandleCutScene( void ){	Handle			tempSound;	short			oldResFile;	CGrafPtr		saved;	GDHandle		savedGD;	Rect			tempRect, tempDestRect;	GWorldPtr		tempGWorld;	PixMapHandle	tempPixMap;	PicHandle		tempPict;	short			i;	GetGWorld(&saved, &savedGD);	oldResFile = CurResFile();	SetRect(&tempRect, 0, 0, 355, 408);	NewGWorld(&tempGWorld, 16, &tempRect, nil, nil, 0L);	tempPixMap = GetGWorldPixMap(tempGWorld);	LockPixels(tempPixMap);	UseResFile(theFileStuff.GWDataFileNumber);	tempPict = GetPicture(4501);	SetGWorld(tempGWorld, nil);	DrawPicture(tempPict, &tempRect);	ReleaseResource((Handle)tempPict);		tempPict = GetPicture(401);		// now run the animation		BackColor(whiteColor);	ForeColor(blackColor);	SetGWorld(&theUserInterface.myCWindowRecord.port, GetMainDevice());		tempPict = GetPicture(4500);	if (tempPict == nil) FatalError("Error loading PICT 4500", true);	SetRect(&tempRect, 0, 0, 640, 480);	DrawPicture(tempPict, &tempRect);	ReleaseResource((Handle)tempPict);	tempSound = Get1Resource('snd ', 1003);	UseResFile(theFileStuff.worldFile);	tempPict = GetPicture(200);		if (tempPict == nil) FatalError("Error loading PICT 200", true);	SetRect(&tempRect, 32, 32, 608, 392);	DrawPicture(tempPict, &tempRect);	ReleaseResource((Handle)tempPict);	// drawing directly to the screen, not a gworld	// now animate the side bars	SndPlay(theAudioStuff.beanieChannel,(SndListHandle)tempSound,true);	ReleaseResource(tempSound);		for (i = 0; i < 18; i++)	{		SetRect(&tempRect, 32 * (i%4), 0, 32 + (32 *(i%4)), 376);		SetRect(&tempDestRect, 0, 0, 32, 376);			CopyBits( &((GrafPtr)tempGWorld)->portBits, &((GrafPtr)(&theUserInterface.myCWindowRecord.port))->portBits,							&tempRect, &tempDestRect, srcCopy, ( RgnHandle )0L );				SetRect(&tempRect, 128 + (32 * (i%4)), 0, 160 + (32 *(i%4)), 376);		SetRect(&tempDestRect, 608, 0, 640, 376);			CopyBits( &((GrafPtr)tempGWorld)->portBits, &((GrafPtr)(&theUserInterface.myCWindowRecord.port))->portBits,							&tempRect, &tempDestRect, srcCopy, ( RgnHandle )0L );		// dials		SetRect(&tempRect, (32 * (i%6)), 376, 32 + (32 *(i%6)), 408);		SetRect(&tempDestRect, 329, 400, 361, 432);		CopyBits( &((GrafPtr)tempGWorld)->portBits, &((GrafPtr)(&theUserInterface.myCWindowRecord.port))->portBits,							&tempRect, &tempDestRect, srcCopy, ( RgnHandle )0L );		SetRect(&tempRect, (32 * ((i + 2)%6)), 376, 32 + (32 *((i+2)%6)), 408);		SetRect(&tempDestRect, 382, 400, 414, 432);		// numbers			CopyBits( &((GrafPtr)tempGWorld)->portBits, &((GrafPtr)(&theUserInterface.myCWindowRecord.port))->portBits,							&tempRect, &tempDestRect, srcCopy, ( RgnHandle )0L );		SetRect(&tempRect, 256, 18 * (i%5), 355, 18 + (18 * (i%5)));		SetRect(&tempDestRect, 321, 437, 420 , 455);			CopyBits( &((GrafPtr)tempGWorld)->portBits, &((GrafPtr)(&theUserInterface.myCWindowRecord.port))->portBits,							&tempRect, &tempDestRect, srcCopy, ( RgnHandle )0L );		GWDelay(20, 20, false);		// a third of a second, so overall runs for 6 seconds	}		// now clean up		DisposeGWorld(tempGWorld);	SetGWorld(saved, savedGD);	UseResFile(oldResFile);}#ifndef DEMOvoid	HackCheckFour( void ){	short		tempResFile;	long		**tempCode;	Boolean		hacked;		hacked = false;	tempResFile = CurResFile();	UseResFile(theFileStuff.applicationFile);		// check for the hack programs by creator and type		// for all volumes mounted need to call CreatorTypeFileSearch	// until a file is found		// now check if the registration data in the application is same as in the prefs	// if there is a prefs resource in the application, then the game has been	// registered at some point	tempCode = (long **)Get1Resource('CODE', 1);	CheckRegistration();	if (gRegistered)	{		Boolean	cheated = false;		if (tempCode)		{			// the prefs file is a registered one.			// check tempPrefs to make sure it is not fiddled. If it is, unregister it						if ((*tempCode)[318] != 99874) cheated = true;			if ((*tempCode)[143] != (**gPrefs).registrationCode) cheated = true;		}		else cheated = true;		if (cheated)		{			// looks like the registration data from the file isn't the same as in the			// application						(**gPrefs).registrationCode = 0;			CopyString((**gPrefs).registerName, "\pUnregistered");			UpdatePreferences();		}	}	if (tempCode) ReleaseResource((Handle)tempCode);		UseResFile(tempResFile);}#endifvoid	DisposeWorldData(void){	ItemSpritePtr		tempItem;	MonsterSpritePtr	tempMonster;	DoorSpritePtr		tempDoor;	TalismanSpritePtr	tempTalisman;	short i, count;		tempMonster = firstMonster;	while (tempMonster) tempMonster = DisposeMonster(tempMonster);	tempDoor = firstDoor;	while (tempDoor) tempDoor = DisposeDoor(tempDoor);		tempItem = firstItem;	while (tempItem) tempItem = DisposeItem(tempItem);		tempItem = firstKeyCopy;	while (tempItem) tempItem = DisposeKeyCopy(tempItem);		tempTalisman = firstTalisman;	while (tempTalisman) tempTalisman = DisposeTalisman(tempTalisman);		firstMonster = nil;	firstDoor = nil;	firstTalisman = nil;	firstItem = nil;	firstKeyCopy = nil;		player.key = 0;	// TODO - check		UseResFile(theFileStuff.worldFile);	// now dispose of all the gworlds which were initialised			count = Count1Resources('sDEF');		for (i = 0; i < count; i++)	{		DisposeHandle((Handle)spriteDefinitions[i]);		DisposeGWorld(theGWorlds.monsterGWorld[i]);	}	for (i = 0; i < 8; i++) DisposeHandle((Handle)doorDefinitions[i]);		for (i = 0; i < 33; i++)	{		if (theAudioStuff.theSounds[i + sndSmallHazard1Death - 128])				ReleaseResource(theAudioStuff.theSounds[i + sndSmallHazard1Death - 128]);	}}