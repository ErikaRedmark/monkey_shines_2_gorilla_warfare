#include	"globals extern.h"void	LoadPreferences (void){	OSErr		theError;	short		theVolume;	long		theDirectory;	FSSpec		preferencesFile;	short		prefsFileNumber;	StringHandle theNameHandle;	theError = FindFolder(kOnSystemDisk, 'sprf', kDontCreateFolder,								&theVolume, &theDirectory);	if (theError != noErr) theError = FindFolder(kOnSystemDisk, kPreferencesFolderType,							kDontCreateFolder, &theVolume, &theDirectory);	if (theError != noErr) theError = FindFolder(kOnSystemDisk, kSystemFolderType,							kDontCreateFolder, &theVolume, &theDirectory);	// if we didn't find a preferences folder on the system	// disk, look for a system folder. This MUST exist	#ifdef	DEMO	theError = FSMakeFSSpec(theVolume, theDirectory, "\pGorilla Warfare Demo Prefs",									&preferencesFile);	#else	theError = FSMakeFSSpec(theVolume, theDirectory, "\pGorilla Warfare Preferences",									&preferencesFile);	#endif		if (theError == noErr)	{		// preferences file was found				prefsFileNumber = FSpOpenResFile(&preferencesFile, fsCurPerm);				// load the preferences				gPrefs = (PrefsHnd)Get1Resource('Pref', 128);				if (gPrefs)	DetachResource((Handle)gPrefs);		else InitialisePrefsRecord();		#ifndef DEMO		globalDifficulty = (**gPrefs).difficulty;#endif				// load the high scores				theScoreHandle = (scoreHandle)Get1Resource('ScOr', 128);		if (theScoreHandle == nil)		{			// no old scores file, and no scores in prefs, so create a new handle						theScoreHandle = (scoreHandle)NewHandle (sizeof(savedHighScores));			if (theScoreHandle == nil) FatalError("Couldn't allocate space for high scores", false);						ClearHighScores();		}		else DetachResource((Handle)theScoreHandle);		theNameHandle = (StringHandle)Get1Resource('STR ', 128);		if (theNameHandle == nil)		{			theNameHandle = NewString("\pDarwin");			AddResource((Handle)theNameHandle, 'STR ', 128, "\p");		}		ReleaseResource((Handle)theNameHandle);				CloseResFile(prefsFileNumber);		UpdatePreferences();	}	else	{		// preferences file not found, so create it and the prefs data structure#ifdef DEMO		FSpCreateResFile( &preferencesFile, 'bNzD', 'Pref', smCurrentScript);#else		FSpCreateResFile( &preferencesFile, 'bNz2', 'Pref', smCurrentScript);#endif		InitialisePrefsRecord();#ifndef DEMO		globalDifficulty = (**gPrefs).difficulty;#endif		theScoreHandle = (scoreHandle)NewHandle (sizeof(savedHighScores));		if (theScoreHandle == nil) FatalError("Couldn't allocate space for high scores", false);		ClearHighScores();		UpdatePreferences();	}	UseResFile(theFileStuff.applicationFile);}void	InitialisePrefsRecord(void){	gPrefs = (PrefsHnd)NewHandleClear(sizeof(PrefsRec));	if (gPrefs == nil) FatalError("Couldn't allocate space for preferences", false);		// convert this to a value between 0 and 8	(**gPrefs).soundVolume = LoWord(theAudioStuff.systemSoundVolume) >> 5;	(**gPrefs).musicVolume = LoWord(theAudioStuff.systemSoundVolume) >> 5;	#ifndef	DEMO		CopyString((**gPrefs).registerName, "\pYour name");		(**gPrefs).serialNumber = 65;	#endif	if ((**gPrefs).soundVolume < 0) (**gPrefs).soundVolume = 0;	if ((**gPrefs).musicVolume < 0) (**gPrefs).musicVolume = 0;	if ((**gPrefs).soundVolume > 8) (**gPrefs).soundVolume = 8;	if ((**gPrefs).musicVolume > 8) (**gPrefs).musicVolume = 8;	(**gPrefs).prefsScreen = nil;		(**gPrefs).majorVersionNumber = 1;	(**gPrefs).minorVersionNumber = 0;	(**gPrefs).patchNumber = 0;#ifndef DEMO	(**gPrefs).difficulty = 1;	// normal#endif}void UpdatePreferences(void){	OSErr		theError;	short		prefsFileNumber, tempFile;	short		theVolume;	long		theDirectory;	FSSpec		preferencesFile;	PrefsHnd	tempPrefs;	scoreHandle	tempScoreHandle;	StringHandle theNameHandle;		tempFile = CurResFile();	theError = FindFolder(kOnSystemDisk, 'sprf', kDontCreateFolder,							&theVolume, &theDirectory);	if (theError != noErr) theError = FindFolder(kOnSystemDisk, kPreferencesFolderType,						kDontCreateFolder, &theVolume, &theDirectory);	if (theError != noErr) theError = FindFolder(kOnSystemDisk, kSystemFolderType,						kDontCreateFolder, &theVolume, &theDirectory);	// if we didn't find a preferences folder on the system disk, look for a system folder	#ifdef	DEMO	theError = FSMakeFSSpec(theVolume, theDirectory, "\pGorilla Warfare Demo Prefs",								&preferencesFile);	#else	theError = FSMakeFSSpec(theVolume, theDirectory, "\pGorilla Warfare Preferences",								&preferencesFile);	#endif	if (theError == noErr)	prefsFileNumber = FSpOpenResFile(&preferencesFile, fsCurPerm);	else	{#ifdef DEMO		FSpCreateResFile( &preferencesFile, 'bNzD', 'Pref', smCurrentScript);#else		FSpCreateResFile( &preferencesFile, 'bNz2', 'Pref', smCurrentScript);#endif		prefsFileNumber = FSpOpenResFile(&preferencesFile, fsCurPerm);	}	// so now we have an open preferences file		// get the current prefs resource		tempPrefs = (PrefsHnd)Get1Resource('Pref', 128);	if (tempPrefs)	{		// now delete it and replace it with the gPrefs resource		RemoveResource((Handle)tempPrefs);		DisposeHandle((Handle)tempPrefs);	// new - make sure		UpdateResFile(prefsFileNumber);		FlushVol(nil, theVolume);	}		AddResource((Handle)gPrefs, 'Pref', 128, "\p");	UpdateResFile(CurResFile());	FlushVol(nil, theVolume);	DetachResource((Handle)gPrefs);	tempScoreHandle = (scoreHandle)Get1Resource('ScOr', 128);	if (tempScoreHandle)	{		// there are high scores in the preferences			RemoveResource((Handle)tempScoreHandle);		DisposeHandle((Handle)tempScoreHandle);	// new - make sure		UpdateResFile(prefsFileNumber);		FlushVol(nil, theVolume);	}			// theScoreHandle should be a valid handle, so add it to the file	// and detach it.			AddResource((Handle)theScoreHandle, 'ScOr', 128, "\p");	UpdateResFile(prefsFileNumber);	FlushVol(nil, theVolume);	DetachResource((Handle)theScoreHandle);		theNameHandle = (StringHandle)Get1Resource('STR ', 128);	if (theNameHandle == nil)	{		theNameHandle = NewString("\pDarwin");		AddResource((Handle)theNameHandle, 'STR ', 128, "\p");	}		ReleaseResource((Handle)theNameHandle);	CloseResFile(prefsFileNumber);	UseResFile(tempFile);}