#include	"globals extern.h"#include	<LowMem.h>void	HandleEndSequence(void);/********************************//*								*//* the main game-control loop	*//*								*//********************************/long GameLoop(FSSpec *theFileSpec){	OSErr		error;	Rect		tempRect;	PicHandle	tempPict;	short		gameCompleted = 0;	/* five lives left */		theGlobals.worldsCompleted = 0;	/* set the score to zero */	theGlobals.gScore = 0;#ifndef DEMO	theGlobals.difficulty = globalDifficulty;	if (theGlobals.difficulty == 0) theGlobals.gLivesLeft = 7;	else theGlobals.gLivesLeft = 5;#else	theGlobals.gLivesLeft = 5;#endif	// run the game	while (theGlobals.gLivesLeft)	{		if ((error = OpenWorldFile(theFileSpec)) == noErr)		{			short result;						#ifdef DEMO				WorldCheckThree();			#endif					// world file is open at this point, and the saved game if appropriate						result = RunAWorld();			SetGWorld(&theUserInterface.myCWindowRecord.port, GetMainDevice());						if (theGlobals.gLivesLeft)			{				theGlobals.worldsCompleted++;								#ifdef DEMO					if (theGlobals.worldsCompleted == 1) gameCompleted = 1;					theGlobals.gLivesLeft = 0;				#else					// TODO - check registration here										if ((theGlobals.worldsCompleted == 5) && (result == 2))					{						gameCompleted = 1;						theGlobals.gLivesLeft = 0;					}					else if (result == 2)					{						// finished Simian City but haven't finished all the other						// worlds, so don't run the end sequence												gameCompleted = 2;						theGlobals.gLivesLeft = 0;						GWDelay(60, 60, false);					}					else if (LocateNextWorldFile(theFileSpec) == noErr)					{						// next file located safely, nothing more needed										}					else	// next file not located					{						WorldFileNotFoundDialog(theFileSpec->name);						theGlobals.gLivesLeft = 0;					}				#endif			}			CloseWorldFile();		}		else theGlobals.gLivesLeft = 0;	}	if (gameCompleted)	{		// first run the end sequence - the world file is still open		#ifndef DEMO		if (gameCompleted == 1) HandleEndSequence();	#endif		// finished all installed worlds		// so put up a message		UseResFile(theFileStuff.GWDataFileNumber);		tempPict = GetPicture(400);		if (tempPict == nil) FatalError("Error loading PICT 400", true);	}	else	{		// game over message		UseResFile(theFileStuff.GWDataFileNumber);		tempPict = GetPicture(2000);		if (tempPict == nil) FatalError("Error loading PICT 2000", true);	}	SetRect(&tempRect, 0, 0, 640, 480);	SetGWorld(&theUserInterface.myCWindowRecord.port, GetMainDevice());	DrawPicture(tempPict, &tempRect);	if (gameCompleted)	{		Handle			tempSound; 		tempSound = Get1Resource('snd ', 1000);		SndPlay(theAudioStuff.beanieChannel,(SndListHandle)tempSound,true);		GWDelay(720, 720, false);		ReleaseResource(tempSound);	}	else	{		PlayASound(sndGameOver);		GWDelay(240, 300, true);	}	ReleaseResource((Handle)tempPict);	UseResFile(theFileStuff.applicationFile);	return theGlobals.gScore;}#ifndef	DEMOOSErr	LocateNextWorldFile(FSSpec *theFile){	StringHandle	theString;	OSErr			theError;	short	wasResFile = CurResFile();	UseResFile(theFileStuff.worldFile);		theString = GetString(128);			theError = FSMakeFSSpec(theFile->vRefNum, theFile->parID, *theString, theFile);	if (theError != noErr)	{		theError = FindFile(theFileStuff.GWParentDirID, *theString, theFile);	}	return theError;}#endif/************************************************************//*															*//*		find and open the world file and get some info		*//*			for the world									*//*															*//************************************************************/OSErr	OpenWorldFile(FSSpec *world1ResFile){	FInfo			theFileInfo;	if (world1ResFile != nil)	{		// check if it is a world file or a saved game				FSpGetFInfo(world1ResFile, &theFileInfo);				if (theFileInfo.fdType == 'gWsV')		{			#ifdef	DEMO							// TODO - shouldn't get here										return fnfErr;						#else						// file is a saved game						BlockMoveData(world1ResFile, &theFileStuff.saveFileSpec, sizeof(FSSpec));			// now need to open the file, extract the world file info and open that						theFileStuff.saveResFile = FSpOpenResFile(&theFileStuff.saveFileSpec, fsRdWrPerm);			LoadFileSpec();			theFileStuff.worldFile = FSpOpenResFile(&theFileStuff.worldFileSpec, fsRdWrPerm);			if (theFileStuff.worldFile == -1)			{				// possible that the save file was created on another machine, so				// find the most likely world file							OSErr theError = FindFile(theFileStuff.GWParentDirID, theFileStuff.worldFileSpec.name, &theFileStuff.worldFileSpec);								if (theError != fnfErr) theFileStuff.worldFile = FSpOpenResFile(&theFileStuff.worldFileSpec, fsRdWrPerm);				else return fnfErr;			}						theFileStuff.saveFileInUse = true;						// TODO - check that the file was opened properly						return noErr;						#endif		}		else	// CHRISTIAN - check that the file is the correct type		{			BlockMoveData(world1ResFile, &theFileStuff.worldFileSpec, sizeof(FSSpec));					theFileStuff.worldFile = FSpOpenResFile(world1ResFile, fsRdWrPerm);			// TODO - check that the file was opened properly									// CHRISTIAN									#ifndef DEMO				theFileStuff.saveFileInUse = false;	// don't use a saved game			#endif			return noErr;		}	}	else return fnfErr;}void	CloseWorldFile(void){	CloseResFile(theFileStuff.worldFile); // close the world file	UseResFile(theFileStuff.applicationFile);			}#ifndef DEMOvoid HandleEndSequence(void){	Handle			tempSound;	CGrafPtr		saved;	GDHandle		savedGD;	Rect			tempRect, tempSpriteRect, tempDestRect;	GWorldPtr		tempGWorld, tempGWorld2;	PixMapHandle	tempPixMap, tempPixMap2;	PicHandle		tempPict;	short			i;	SCStatus		theStatus;	Boolean			soundDone;	GetGWorld(&saved, &savedGD);	UseResFile(theFileStuff.GWDataFileNumber);	SetRect(&tempRect, 0, 0, 4480, 896);	NewGWorld(&tempGWorld, 16, &tempRect, nil, nil, 0L);	tempPixMap = GetGWorldPixMap(tempGWorld);	LockPixels(tempPixMap);	tempPict = GetPicture(402);	SetGWorld(tempGWorld, nil);	DrawPicture(tempPict, &tempRect);	ReleaseResource((Handle)tempPict);	SetRect(&tempRect, 0, 0, 640, 480);	NewGWorld(&tempGWorld2, 16, &tempRect, nil, nil, 0L);	tempPixMap2 = GetGWorldPixMap(tempGWorld2);	LockPixels(tempPixMap2);		tempPict = GetPicture(401);	SetGWorld(tempGWorld2, nil);	DrawPicture(tempPict, &tempRect);	ReleaseResource((Handle)tempPict);			// now run the animation		BackColor(whiteColor);	ForeColor(blackColor);	 	tempSound = Get1Resource('snd ', 1002);	SndPlay(theAudioStuff.beanieChannel,(SndListHandle)tempSound,true);	soundDone = false;	SetGWorld(theGWorlds.screenGWorld, nil);	SetRect(&tempRect, 0, 0, 640, 480);	CopyBits( &((GrafPtr)tempGWorld2)->portBits, &((GrafPtr)theGWorlds.screenGWorld)->portBits,					&tempRect, &tempRect, srcCopy, ( RgnHandle )0L );						i = 0;		while (!soundDone)	{		SetGWorld(theGWorlds.screenGWorld, nil);		SetRect(&tempRect, 2, 185, 640, 480);		CopyBits( &((GrafPtr)tempGWorld2)->portBits, &((GrafPtr)theGWorlds.screenGWorld)->portBits,							&tempRect, &tempRect, srcCopy, ( RgnHandle )0L );						SetRect(&tempSpriteRect, 224 * (i % 20), 224 * (i/20), 224 + (224 * (i % 20)), 224 + (224 * (i/20)));		SetRect(&tempDestRect, 241, 185, 465, 409);		CopyBits( &((GrafPtr)tempGWorld)->portBits, &((GrafPtr)theGWorlds.screenGWorld)->portBits,							&tempSpriteRect, &tempDestRect, srcCopy + transparent, ( RgnHandle )0L );				SetRect(&tempDestRect, 370, 205, 594, 428);		CopyBits( &((GrafPtr)tempGWorld)->portBits, &((GrafPtr)theGWorlds.screenGWorld)->portBits,							&tempSpriteRect, &tempDestRect, srcCopy + transparent, ( RgnHandle )0L );				SetRect(&tempDestRect, 101, 199, 325, 423);		CopyBits( &((GrafPtr)tempGWorld)->portBits, &((GrafPtr)theGWorlds.screenGWorld)->portBits,							&tempSpriteRect, &tempDestRect, srcCopy + transparent, ( RgnHandle )0L );				SetRect(&tempDestRect, 216, 256, 440, 480);		CopyBits( &((GrafPtr)tempGWorld)->portBits, &((GrafPtr)theGWorlds.screenGWorld)->portBits,							&tempSpriteRect, &tempDestRect, srcCopy + transparent, ( RgnHandle )0L );				SetRect(&tempDestRect, 416, 254, 640, 478);		CopyBits( &((GrafPtr)tempGWorld)->portBits, &((GrafPtr)theGWorlds.screenGWorld)->portBits,							&tempSpriteRect, &tempDestRect, srcCopy + transparent, ( RgnHandle )0L );				SetRect(&tempDestRect, 2, 246, 226, 470);		CopyBits( &((GrafPtr)tempGWorld)->portBits, &((GrafPtr)theGWorlds.screenGWorld)->portBits,							&tempSpriteRect, &tempDestRect, srcCopy + transparent, ( RgnHandle )0L );				SetGWorld(&theUserInterface.myCWindowRecord.port, GetMainDevice());		SetRect(&tempDestRect, 0, 0, 640, 480);		CopyBits( &((GrafPtr)theGWorlds.screenGWorld)->portBits, &((GrafPtr)(&theUserInterface.myCWindowRecord.port))->portBits,							&tempDestRect, &tempDestRect, srcCopy, ( RgnHandle )0L );			GWDelay(2, 2, false);				i++;		if (i == 80) i = 0;		SndChannelStatus(theAudioStuff.beanieChannel, sizeof(SCStatus), &theStatus);		if (theStatus.scChannelBusy == false) soundDone = true;	}		ReleaseResource(tempSound);	DisposeGWorld(tempGWorld);	DisposeGWorld(tempGWorld2);	SetGWorld(saved, savedGD);	GWDelay(0, 60, false); // 1 second delay}#endif/****************************************************************//*																*//* set up a window in the middle of the screen and display a	*//* message, then wait a few seconds								*//*																*//****************************************************************/void DoMessage(void){	Rect theRect;	PicHandle tempPict;	RGBColor	theColor;			GWDelay(0, 20, false); // 1/3 second delay	SetRect(&theRect, 186, 140, 454, 284);	SetGWorld(theGWorlds.screenGWorld, nil);	UseResFile(theFileStuff.GWDataFileNumber);	tempPict = GetPicture(2001);	if (tempPict == nil) FatalError("Error loading PICT 2001", true);	DrawPicture(tempPict, &theRect);	SetGWorld(&theUserInterface.myCWindowRecord.port, GetMainDevice());	ReleaseResource((Handle)tempPict);	UseResFile(theFileStuff.applicationFile);	theColor.red = 52000;	theColor.green = 52000;	theColor.blue = 52000;	OpColor(&theColor);		CopyBits( &((GrafPtr)theGWorlds.screenGWorld)->portBits, &((GrafPtr)(&theUserInterface.myCWindowRecord.port))->portBits,  		&theRect, &theRect, srcCopy + blend, ( RgnHandle )0L );	UseResFile(theFileStuff.worldFile);		GWDelay(0, 60, false); // 1 second delay}