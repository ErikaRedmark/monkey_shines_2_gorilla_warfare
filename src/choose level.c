#include	"globals extern.h"RgnHandle	selectionCursorRgn;ControlHandle	newGameHandle, loadGameHandle, addonWorldHandle;#ifndef DEMOControlHandle	easyHandle, normalHandle;#endifshort	GetStartingLevel( FSSpec *theFile ){	short			thePart;	WindowPtr		whichWindow;	Point			mousePoint;	char			theChar;	ControlHandle	theControl;	Boolean			gotWorld = false;	EventRecord		getWorldEvent;	Rect			tempRect;	short			selection;	PicHandle		tempPict;	long			mem;	OSErr			theError;	UseResFile(theFileStuff.GWDataFileNumber);	tempPict = GetPicture(600);	if (tempPict == nil) FatalError("Error loading PICT 600", true);	SetGWorld(theGWorlds.screenGWorld, nil); // draw it in the screen GWorld	SetRect(&tempRect, 0, 0, 640, 480);	DrawPicture(tempPict, &tempRect);	ReleaseResource((Handle)tempPict);	SetGWorld(&theUserInterface.myCWindowRecord.port, GetMainDevice());	FlashFadeIn();	CustomShowCursor();	StopInterfaceMusic();	newGameHandle = GetNewControl(30000, theUserInterface.theWindow);	loadGameHandle = GetNewControl(30002, theUserInterface.theWindow);	addonWorldHandle = GetNewControl(30004, theUserInterface.theWindow);	#ifndef DEMO	easyHandle = GetNewControl(30006, theUserInterface.theWindow);	normalHandle = GetNewControl(30008, theUserInterface.theWindow);#endif		UseResFile(theFileStuff.applicationFile);	ShowControl(newGameHandle);	ShowControl(loadGameHandle);	ShowControl(addonWorldHandle);	#ifndef DEMO		ShowControl(easyHandle);		ShowControl(normalHandle);		CheckRegistration(); // TODO - shouldn't get here unless a valid code has been entered		if (globalDifficulty == 1)		{			SetControlReference(easyHandle, 0);			SetControlReference(normalHandle, 1);		}		else		{			SetControlReference(easyHandle, 1);			SetControlReference(normalHandle, 0);		}				UpdateControls(theUserInterface.theWindow, theUserInterface.theWindow->visRgn);	#endif		SetupSelectionRgn();	GetMouse(&mousePoint);	HandleSelectionMouseMoved(mousePoint);		while (!gotWorld)	{		if (WaitNextEvent(everyEvent, &getWorldEvent, 20L, selectionCursorRgn))		{			switch (getWorldEvent.what)			{				case keyDown:				case autoKey:					theChar = getWorldEvent.message & charCodeMask;					if (theChar == 'q' && ((getWorldEvent.modifiers & cmdKey) != 0))					{						KillControls(theUserInterface.theWindow);						CleanUpAndQuit();						ExitToShell();					}					else if (theChar == 27) // presumably escape					{						KillControls(theUserInterface.theWindow);						selection = 0;						gotWorld = true;					}					break;				case mouseDown:					thePart = FindWindow (getWorldEvent.where, &whichWindow);					if (thePart == inContent)					{						mousePoint = getWorldEvent.where;						GlobalToLocal(&mousePoint);						thePart = FindControl(mousePoint, whichWindow, &theControl);												if (theControl) PlayASound(sndClick);												if (theControl == newGameHandle)						{							if (TrackControl(theControl, getWorldEvent.where, nil))							{							#ifdef DEMO								theError = FindFile(theFileStuff.GWParentDirID, "\pLava P'Lava Demo", theFile);							#else								theError = FindFile(theFileStuff.GWParentDirID, "\pRoman a Go-Go 1.0.2", theFile);							#endif																if (theError == noErr)								{									selection = 1;									gotWorld = true;								}								else								{							#ifdef DEMO									WorldFileNotFoundDialog("\pLava P'Lava Demo");							#else									WorldFileNotFoundDialog("\pRoman a Go-Go");							#endif								}							}						}						else if (theControl == loadGameHandle)						{							if (TrackControl(theControl, getWorldEvent.where, nil))							{								#ifdef DEMO									OnlyAvailableInFullVersion();								#else														if (UserSelectSaveFile(theFile) == 0)									{										gotWorld = true;										selection = 2;									}								#endif							}						}						else if (theControl == addonWorldHandle)						{							if (TrackControl(theControl, getWorldEvent.where, nil))							{								#ifdef	DEMO									OnlyAvailableInFullVersion();																#else									if (UserSelectWorldFile(theFile) == 0)									{										gotWorld = true;										selection = 3;									}								#endif							}						}#ifndef DEMO						else if (theControl == easyHandle)						{							if (TrackControl(theControl, getWorldEvent.where, nil))							{								globalDifficulty = 0;	// easy															SetControlReference(easyHandle, 1);								SetControlReference(normalHandle, 0);								UpdateControls(theUserInterface.theWindow, theUserInterface.theWindow->visRgn);							}						}						else if (theControl == normalHandle)						{							if (TrackControl(theControl, getWorldEvent.where, nil))							{								globalDifficulty = 1;	// normal															SetControlReference(easyHandle, 0);								SetControlReference(normalHandle, 1);								UpdateControls(theUserInterface.theWindow, theUserInterface.theWindow->visRgn);							}						}#endif					}					break;				case updateEvt:					HandleSelectionUpdate(&getWorldEvent);					break;				case osEvt:					if ((getWorldEvent.message & 0xFA000000) != 0) HandleSelectionMouseMoved(getWorldEvent.where);					break;			}		}	}	#ifndef DEMO	(**gPrefs).difficulty =  globalDifficulty;	UpdatePreferences();#endif	CustomHideCursor();	DisposeRgn(selectionCursorRgn); selectionCursorRgn = 0; // make sure it is reallocated next time	KillControls(theUserInterface.theWindow);	MaxMem(&mem);	// was a world selected ?	if (selection == 0) return 1;	else return noErr;}OSErr	UserSelectWorldFile(FSSpec *theFile){	SFTypeList			myTypeList;	StandardFileReply	mySFReply;	short				myNumTypes;	// prompt for a world file to play	myTypeList[0] = 'wRlD';	myNumTypes = 1;	StandardGetFile(nil, myNumTypes, myTypeList, &mySFReply);	CopyBits( &((GrafPtr)theGWorlds.screenGWorld)->portBits,  &((GrafPtr)(&theUserInterface.myCWindowRecord.port))->portBits,			&(theGWorlds.screenGWorld->portRect), &(theGWorlds.screenGWorld->portRect), srcCopy, ( RgnHandle )0L );	SetCCursor(theUserInterface.myCursor);	if (mySFReply.sfGood) BlockMoveData(&mySFReply.sfFile, theFile, sizeof(FSSpec));	else return	1;	return 0;}#ifndef	DEMOOSErr	UserSelectSaveFile(FSSpec *theFile){	SFTypeList			myTypeList;	StandardFileReply	mySFReply;	short				myNumTypes;	// prompt for a world file to play	myTypeList[0] = 'gWsV';	myNumTypes = 1;	StandardGetFile(nil, myNumTypes, myTypeList, &mySFReply);	CopyBits( &((GrafPtr)theGWorlds.screenGWorld)->portBits,  &((GrafPtr)(&theUserInterface.myCWindowRecord.port))->portBits,			&(theGWorlds.screenGWorld->portRect), &(theGWorlds.screenGWorld->portRect), srcCopy, ( RgnHandle )0L );	SetCCursor(theUserInterface.myCursor);	if (mySFReply.sfGood) BlockMoveData(&mySFReply.sfFile, theFile, sizeof(FSSpec));	else return 1;		return 0;}#endifvoid SetupSelectionRgn (void){	RgnHandle	tempRgn;	tempRgn = NewRgn();	if (selectionCursorRgn == 0)	selectionCursorRgn = NewRgn();		SetRectRgn(selectionCursorRgn, 0, 0, 640, 480);		// new game		SetRectRgn(tempRgn, 5, 202, 249, 276);	DiffRgn(selectionCursorRgn, tempRgn, selectionCursorRgn);	// controls	SetRectRgn(tempRgn, 5, 282, 249, 356);	DiffRgn(selectionCursorRgn, tempRgn, selectionCursorRgn);	// help		SetRectRgn(tempRgn, 5, 364, 249, 438);	DiffRgn(selectionCursorRgn, tempRgn, selectionCursorRgn);		DisposeRgn(tempRgn);}void HandleSelectionMouseMoved(Point mousePoint){	short thePart;	ControlHandle theControl;			GlobalToLocal(&mousePoint);	thePart = FindControl(mousePoint, theUserInterface.theWindow, &theControl);	if (theControl)	{		// moved into a control			SetControlReference(newGameHandle, 0);		SetControlReference(loadGameHandle, 0);		SetControlReference(addonWorldHandle, 0);		// now hilight the control under the mouse and update all				SetControlReference(theControl, 2);		UpdateControls(theUserInterface.theWindow, theUserInterface.theWindow->visRgn);				// the new mouse region needs to be the controls rect		RectRgn(selectionCursorRgn, &(*theControl)->contrlRect);	}	else	{		// moved out of a control			SetControlReference(newGameHandle, 0);		SetControlReference(loadGameHandle, 0);		SetControlReference(addonWorldHandle, 0);				// now update the controls				UpdateControls(theUserInterface.theWindow, theUserInterface.theWindow->visRgn);				// the region now needs to be the default		SetupSelectionRgn();	}}void HandleSelectionUpdate(EventRecord *eventPtr){	WindowPtr	currentFrontWindow = (WindowPtr)eventPtr->message;	RgnHandle	theRegion;		BeginUpdate(currentFrontWindow);	if (currentFrontWindow == theUserInterface.theWindow)	{		theRegion = currentFrontWindow->visRgn;							UpdateControls(currentFrontWindow, theRegion);	}		EndUpdate(currentFrontWindow);}void	OnlyAvailableInFullVersion(void){	RgnHandle	theRegion;	WindowPtr	dialogWindow;	ControlHandle	dialogOkayButton, tempControl;	Rect			tempRect;	PicHandle tempPict;	UseResFile(theFileStuff.GWDataFileNumber);	tempPict = GetPicture(912);	if (tempPict == nil) FatalError("Error loading PICT 912", true);	tempRect.left = 0;	tempRect.right = (**tempPict).picFrame.right;	tempRect.top = 0;	tempRect.bottom = (**tempPict).picFrame.bottom;		CenterRectInRect(&tempRect, &(**theUserInterface.gameGDevice).gdRect);		dialogWindow  = NewCWindow(nil, &tempRect, "\p", true,						plainDBox, (WindowPtr)-1L, false, (long)nil);	SetPort(dialogWindow);	DrawPicture(tempPict, &(**tempPict).picFrame);	ReleaseResource((Handle)tempPict);	UseResFile(theFileStuff.applicationFile);	SetRect(&tempRect, 110, 195, 170, 215); 	dialogOkayButton = NewControl( dialogWindow, &tempRect, "\pOkay", true, 0, 0, 0, 0, 0 );	tempControl =	MarksCustomDialog(dialogWindow);	if (tempControl == nil)	{		HiliteControl(dialogOkayButton, 10);		GWDelay(0, 10, false);		HiliteControl(dialogOkayButton, 0);	}								DisposeWindow(dialogWindow);	SetGWorld(&theUserInterface.myCWindowRecord.port, GetMainDevice());	// update the window behind the control	theRegion = theUserInterface.theWindow->visRgn;		tempRect.left = (**theRegion).rgnBBox.left;	tempRect.right = (**theRegion).rgnBBox.right;	tempRect.top = (**theRegion).rgnBBox.top;	tempRect.bottom = (**theRegion).rgnBBox.bottom;		CopyBits(  &((GrafPtr)theGWorlds.screenGWorld)->portBits, &((GrafPtr)(&theUserInterface.myCWindowRecord.port))->portBits,		&tempRect, &tempRect,  srcCopy, ( RgnHandle )0L );			UpdateControls(theUserInterface.theWindow, theRegion);}