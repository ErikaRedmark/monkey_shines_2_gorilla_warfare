#include	"globals extern.h"SpringSpritePtr AllocateSpring(void){	SpringSpritePtr	tempSprite, temp;		tempSprite = (SpringSpritePtr)NewPtrClear(sizeof(SpringSprite));	if (tempSprite == nil) FatalError("Sprite Allocation Failed", true);	if (firstSpring == nil) firstSpring = tempSprite;	else	{		// find the last hazard in the list				temp = firstSpring;			while (temp->nextSprite != nil) temp = temp->nextSprite;			temp->nextSprite = tempSprite;		tempSprite->prevSprite = temp;	}	return tempSprite;}SpringSpritePtr DisposeSpring(SpringSpritePtr theSprite){	SpringSpritePtr	returnValue;	SpringSpritePtr	tempSprite = theSprite;	if (theSprite == nil) FatalError("Trying to dispose of zero sprite", true);	returnValue = theSprite->nextSprite;		if (theSprite->nextSprite == nil)	// must be the last talisman in the list	{		if (theSprite == firstSpring) firstSpring = nil;	}	else if (theSprite == firstSpring)	{		firstSpring = theSprite->nextSprite;	}	if (tempSprite->nextSprite) (tempSprite->nextSprite)->prevSprite = tempSprite->prevSprite;	if (tempSprite->prevSprite) (tempSprite->prevSprite)->nextSprite = tempSprite->nextSprite;	DisposePtr( (Ptr)theSprite);	return returnValue;}void	HandleSprings(Rect *drawingRect){	SpringSpritePtr tempSpring = firstSpring;		while (tempSpring)	{		HandleOneSpring(tempSpring, drawingRect);		tempSpring = tempSpring->nextSprite;	}}// Hande the springvoid HandleOneSpring(SpringSpritePtr theSpring, Rect *drawingRect){	Rect dummy, testRect;	short insetV;	// only need to clip springs vertically, since only 24 pixels wide		// check if the spring is on the visible part of the screen	if (SectRect(drawingRect, &theSpring->theRect, &dummy)) theSpring->needToDraw = true;	else theSpring->needToDraw = false;		// if we don't need to draw it, nothing more to do		if (theSpring->needToDraw == false) return;	// is the player landing on the spring ?	if (player.gLanding && (theSpring->frame > 1))	// don't want a spring to go again immediately	{		// player is landing. Should spring if he is on it				if (theSpring->vArray * 24 == (player.theRect.top + darwinHeight))			if ((theSpring->theRect.right > player.theRect.left) && (theSpring->theRect.left < player.theRect.right))		{			theSpring->springDirection = 1;	// start springing			theSpring->frame = 0;						// ones before "theSpring" in the list should have their frame increased. The ones after will be dealt with			// further through the loop						CheckJoiningSprings(theSpring);						#ifdef DEMO				if (hackedSix) FatalError("Error with linked springs", true);			#endif						SetRect(&testRect, player.theRect.left + 16, player.theRect.top, player.theRect.left + 48, player.theRect.bottom);			if (TestMoveSpriteUp(&testRect, 15) == 15)			{				if (!player.dying && !player.gDead) // make sure it doesn't try to spring if he's dead				{					player.speedv = -15;	// moving up 15 pixels per frame					player.frame = 7; // make sure he can jump immediately					player.gJumpingFrames = true;					player.iconRow = jumpRow;					player.movingVertically = true;					player.gLanding = false;					player.gOnRightConveyor = false;					player.gOnLeftConveyor = false;										if (player.gThrowingBanana)					{						player.gThrowingBanana = false;						player.delayToNextThrow = 8;					}				}								PlayASound(sndSpring);			}		}	}	if (theSpring->springDirection == 1)	{		// this spring is active				if (theSpring->artificiallySprung) theSpring->artificiallySprung = false;		else theSpring->frame++;				if (theSpring->frame == 11)		{			theSpring->frame = 0;			theSpring->springDirection = 0;									}	}	else	{		// slight movement to the spring				theSpring->frame = 12 + (frameCount & 3);		//		if (frameCount & 2) theSpring->frame = 6;//		else theSpring->frame = 7;	}	insetV = 0;	theSpring->drawingHeight = dummy.bottom - dummy.top;		if (theSpring->drawingHeight != 48)	{		// need to clip  vertically			if (theSpring->theRect.top < drawingRect->top) insetV = drawingRect->top - theSpring->theRect.top;	}	theSpring->dest = (short *)(theGWorlds.safeMemPtr + ((theSpring->theRect.top + insetV - (24 * minActualVert)) * theGWorlds.safeRowOffSet) +						2 * (theSpring->theRect.left - (24 * minActualHoriz)));	theSpring->source = (short *)(theGWorlds.springMemPtr + (48 * theSpring->frame) + (theGWorlds.platformRowOffSet * (theSpring->iconRow + insetV)));}// if one spring goes, need to check if there are any left or right attached to itvoid	CheckJoiningSprings(SpringSpritePtr spring){	SpringSpritePtr	tempSprite;	short			h, hMin, hMax, v;	Boolean			done;		v = spring->vArray;	h = spring->hArray;	hMin = h;		done = false;		while (!done)	{		if (hMin == 0) done = true;		if (GetOtherData(hMin - 1, v) & maskSpring) hMin--;		else done = true;	}		hMax = h;		done = false;		while (!done)	{		if (hMax == (roomWidthTiles - 1)) done = true;		if (GetOtherData(hMax + 1, v) & maskSpring) hMax++;		else done = true;	}		// now go through the list fixing the springs		done = false; // found the start spring ?		tempSprite = firstSpring;		while (tempSprite)	{		if (tempSprite == spring) done = true;				if ((tempSprite->vArray == v) && ((tempSprite->hArray >= hMin) && (tempSprite->hArray <= hMax)))		{			tempSprite->springDirection = 1;			if (done) tempSprite->frame = 0;			else tempSprite->frame = 1;		}				tempSprite = tempSprite->nextSprite;	}}