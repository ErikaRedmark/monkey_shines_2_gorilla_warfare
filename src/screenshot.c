#include "globals extern.h"void PlotBitMap(PixMap *pix, short h, short v, short mode){	GrafPtr port;	Rect src, dst;	dst = src = pix->bounds;	OffsetRect(&dst, h, v);	GetPort(&port);	CopyBits((BitMap *)pix, &port->portBits, &src, &dst, mode, NULL);}void SavePixMap(PixMap *pix){	PicHandle pic;	CGrafPtr saved;	GrafPort port;	Rect r;	OpenCPicParams	parameters;		StandardFileReply	myReply;	OSErr error;	short	pictFileRefNum;	long	dataLength, zeroData, count;	r = pix->bounds;	parameters.srcRect = pix->bounds;	parameters.hRes = 0x00480000;	parameters.vRes = 0x00480000;	GetGWorld(&saved, nil);	OpenPort(&port);	ClipRect(&r);	pic = OpenCPicture(&parameters);	PlotBitMap(pix, 0, 0, srcCopy);	ClosePicture();	SetGWorld(saved, nil);	ClosePort(&port);	if (GetHandleSize((Handle) pic) == sizeof(Picture))	{		KillPicture(pic);		pic = NULL;	}	else	{		ISpSuspend();		CustomShowCursor();		FlushEvents(everyEvent, 0);				// save the PicHandle to a PICT file			StandardPutFile("\pSave Picture As:", "\puntitled", &myReply);		error = noErr;				if (myReply.sfGood)		{			if (!myReply.sfReplacing) error = FSpCreate(&myReply.sfFile, 'WAVE', 'PICT', smSystemScript);						if (error != noErr)			{												}						error = FSpOpenDF(&myReply.sfFile, fsRdWrPerm, &pictFileRefNum);						if (error != noErr)			{												}						zeroData = 0;			dataLength = 4;						for (count = 1; count <= 512; count += dataLength)			{				error = FSWrite(pictFileRefNum, &dataLength, &zeroData);				if (error != noErr)				{												}			}						dataLength = GetHandleSize((Handle)pic);			HLock((Handle)pic);						error = FSWrite(pictFileRefNum, &dataLength, *pic);						DrawPicture(pic, &(**pic).picFrame);						HUnlock((Handle)pic);						FSClose(pictFileRefNum);		}			DisposeHandle((Handle)pic);		SetCCursor(theUserInterface.myCursor);		CustomHideCursor();		ISpResume();		justSaved = true;	// hack to stop the game catching up on dropped frames	}}