#include	"globals extern.h"DissolverSpritePtr AllocateDissolver(void){	DissolverSpritePtr	tempSprite, temp;		tempSprite = (DissolverSpritePtr)NewPtrClear(sizeof(DissolverSprite));	if (tempSprite == nil) FatalError("Sprite Allocation Failed", true);	if (firstDissolver == nil) firstDissolver = tempSprite;	else	{		// find the last hazard in the list				temp = firstDissolver;			while (temp->nextSprite != nil) temp = temp->nextSprite;			temp->nextSprite = tempSprite;		tempSprite->prevSprite = temp;	}	return tempSprite;}DissolverSpritePtr DisposeDissolver(DissolverSpritePtr theSprite){	DissolverSpritePtr	returnValue;	DissolverSpritePtr	tempSprite = theSprite;	if (theSprite == nil) FatalError("Trying to dispose of zero sprite", true);	returnValue = theSprite->nextSprite;		if (theSprite->nextSprite == nil)	// must be the last talisman in the list	{		if (theSprite == firstDissolver) firstDissolver = nil;	}	else if (theSprite == firstDissolver)	{		firstDissolver = theSprite->nextSprite;	}	if (tempSprite->nextSprite) (tempSprite->nextSprite)->prevSprite = tempSprite->prevSprite;	if (tempSprite->prevSprite) (tempSprite->prevSprite)->nextSprite = tempSprite->nextSprite;	DisposePtr( (Ptr)theSprite);	return returnValue;}void	HandleDissolvers(void){	DissolverSpritePtr tempDissolver = firstDissolver;		while (tempDissolver)	{		HandleOneDissolver(tempDissolver);		tempDissolver = tempDissolver->nextSprite;	}}/*Use frameDirection to decide is the trapdoor is opening.Use jumpStatus as a frame counter to decide if the trapdoor should close.*/void HandleOneDissolver(DissolverSpritePtr theDissolver){	// check if the dissolver is on the visible part of the screen	if ((theDissolver->hArray >= minActualHoriz) && (theDissolver->hArray <= maxActualHoriz) &&				(theDissolver->vArray >= minActualVert) && (theDissolver->vArray <= maxActualVert)) theDissolver->needToDraw = true;	else theDissolver->needToDraw = false;	// if we don't need to draw it, nothing more to do		if (theDissolver->needToDraw == false) return;	if (theDissolver->dissolverStatus != 0)	{		// the trapdoor has opened, so count down				theDissolver->dissolverStatus--;				if (theDissolver->dissolverStatus < 8) theDissolver->frame = theDissolver->dissolverStatus;				if (theDissolver->dissolverStatus == 0)					SetOtherData(theDissolver->hArray, theDissolver->vArray, maskDissolver | theDissolver->subKind);	}	else if (theDissolver->dissolverDirection == 0)	{		// trapdoor is not already opening				// now check if Darwin is on the dissolver		if (!player.movingVertically && (frameCount & 1))		{			/* not jumping or falling, so must be walking */			/* now check if player is above a particular dissolving platform */			/* if so, set platform to increase frame and draw */						/* platforms should only dissolve on even frames */			if (theDissolver->theRect.top == (player.theRect.top + darwinHeight))				if ((theDissolver->theRect.right > player.theRect.left) && (theDissolver->theRect.left < player.theRect.right))						/* looks like player is on this dissolver */						{				theDissolver->dissolverDirection = 1;	// mark the trapdoor as opening			}		}	}	else	{		// the trapdoor was already opening			if (frameCount & 1) theDissolver->frame++;		if (theDissolver->frame == 7)		{			// trapdoor is fully open						SetOtherData(theDissolver->hArray, theDissolver->vArray, 0);	// remove it from level array			theDissolver->dissolverStatus = 120;	// set counter for about 2 seconds			theDissolver->dissolverDirection = 0;		}	}	theDissolver->dest = (short *)(theGWorlds.safeMemPtr + ((theDissolver->theRect.top - (24 * minActualVert)) * theGWorlds.safeRowOffSet)									+ 2 * (theDissolver->theRect.left - (24 * minActualHoriz)));	theDissolver->source = (short *)(theGWorlds.dissolverMemPtr + (48 * theDissolver->frame) + (theGWorlds.platformRowOffSet * theDissolver->iconRow));}