#include	"globals.h"#include	"gamma.h"#include	<ControlStrip.h>#ifdef useProfiler#include <profiler.h>#endifextern	FilePlayCompletionUPP	soundCallback;/************************************//*									*//* the main routine and event loop	*//*									*//************************************/void	main ( void ){	Handle		menuBar;	MenuHandle	menu;	EventRecord event;	Rect		tempRect;	PicHandle	tempPict;	Point		mousePoint;// profiler#ifdef useProfiler	ProfilerInit(collectDetailed, bestTimeBase, 50, 10);#endif	StartupStuff();#ifndef DEMO	gRegistered = 0; // set to not registered#endif/* delay to make sure user has seen the screen */	GWDelay(0, 300, true);	/* draw the second splash screen */	SetGWorld(theGWorlds.screenGWorld, nil);	UseResFile(theFileStuff.GWDataFileNumber);	tempPict = GetPicture(1000);	if (tempPict == nil) FatalError("Error loading PICT 1000 (splash screen)", true);	SetRect(&tempRect, 0, 0, 640, 480);		DrawPicture(tempPict, &tempRect);	ReleaseResource((Handle)tempPict);	UseResFile(theFileStuff.applicationFile);	SetGWorld(&theUserInterface.myCWindowRecord.port, GetMainDevice());#ifdef DEMO	WorldCheckTwo();#endif	FlashFadeIn();/* set a couple of flags */	theUserInterface.gQuit = false;	theUserInterface.gInBackGround = false;		// foreground process/* set up the menus */	menuBar = GetNewMBar(128);	SetMenuBar(menuBar);		menu = GetMenuHandle (128);	AppendResMenu(menu, 'DRVR');		// pop-up menus for sound and music volume		theUserInterface.soundMenu = GetMenu(100);	InsertMenu(theUserInterface.soundMenu, -1);	CheckItem(theUserInterface.soundMenu, ((**gPrefs).soundVolume) + 1, true);		theUserInterface.musicMenu = GetMenu(101);	InsertMenu(theUserInterface.musicMenu, -1);	CheckItem(theUserInterface.musicMenu, ((**gPrefs).musicVolume) + 1, true);		GWDelay(0, 300, true);	// draw the control screen	DrawControlScreen(true);	theUserInterface.gDialogInBox = false;	// now run the registration dialog	#ifdef	DEMO		RegistrationInfoDialog();	#else		CheckRegistration();		if (!gRegistered)	RegisterDialog();	#endif	SetupRgn();	GetMouse(&mousePoint); HandleMouseMoved(mousePoint);	while (!theUserInterface.gQuit)	{		if (WaitNextEvent(everyEvent, &event, 20L, theUserInterface.cursorRgn)) DoEvent(&event);#ifndef DEMO		else		{			if ((theAudioStuff.musicType == typeAIFF) && (theAudioStuff.restartMusic))			{				SndStartFilePlay (theAudioStuff.musicChannel, theAudioStuff.fileRefNum, nil, 20480, nil, nil, soundCallback, true);				theAudioStuff.restartMusic = false;			}		}#endif	}/* user has clicked to exit, so get rid of the music libs */	CleanUpAndQuit();}// initialise a region which is the screen minus the buttons so we// can watch for mouse moved eventsvoid SetupRgn (void){	RgnHandle	tempRgn;		tempRgn = NewRgn();	if (theUserInterface.cursorRgn == 0)	theUserInterface.cursorRgn = NewRgn();		SetRectRgn(theUserInterface.cursorRgn, 0, 0, 640, 480);		// new game		SetRectRgn(tempRgn, 31, 104, 303, 181);	DiffRgn(theUserInterface.cursorRgn, tempRgn, theUserInterface.cursorRgn);	// controls	SetRectRgn(tempRgn, 31, 185, 303, 250);	DiffRgn(theUserInterface.cursorRgn, tempRgn, theUserInterface.cursorRgn);	// help		SetRectRgn(tempRgn, 31, 334, 303, 411);	DiffRgn(theUserInterface.cursorRgn, tempRgn, theUserInterface.cursorRgn);	// music	SetRectRgn(tempRgn, 358, 132, 630, 209);	DiffRgn(theUserInterface.cursorRgn, tempRgn, theUserInterface.cursorRgn);	// sound		SetRectRgn(tempRgn, 358, 210, 630, 287);	DiffRgn(theUserInterface.cursorRgn, tempRgn, theUserInterface.cursorRgn);	// quit		SetRectRgn(tempRgn, 31, 417, 303, 480);	DiffRgn(theUserInterface.cursorRgn, tempRgn, theUserInterface.cursorRgn);	// high scores		SetRectRgn(tempRgn, 31, 254, 303, 331);	DiffRgn(theUserInterface.cursorRgn, tempRgn, theUserInterface.cursorRgn);			#ifdef	DEMO	if (theUserInterface.registerInfoButton != 0)	{		SetRectRgn(tempRgn, 357, 333, 566, 371);		DiffRgn(theUserInterface.cursorRgn, tempRgn, theUserInterface.cursorRgn);			}		#else		if (theUserInterface.enterCodeButton != 0)	{		SetRectRgn(tempRgn, 357, 380, 566, 418);		DiffRgn(theUserInterface.cursorRgn, tempRgn, theUserInterface.cursorRgn);			}	#endif		DisposeRgn(tempRgn);}void CleanUpAndQuit( void ){	Boolean		waitedLongEnough = false;	Rect		tempRect;	PicHandle	tempPict;	short		i;		StopMusic();	SetDefaultOutputVolume(theAudioStuff.systemSoundVolume);	CustomHideCursor();		UseResFile(theFileStuff.GWDataFileNumber);	tempPict = GetPicture(300);		if (tempPict)	{		SetRect(&tempRect, 0, 0, 640, 480);		DrawPicture(tempPict, &tempRect);		ReleaseResource((Handle)tempPict);	}	UseResFile(theFileStuff.applicationFile);	CustomShowCursor();	GWDelay(60, 300, true);	CloseWindow(theUserInterface.theWindow);	if (theUserInterface.blankingWindow) CloseWindow(theUserInterface.blankingWindow);	ShowTheMenuBar();	SetCursor(&qd.arrow);	DisposeCCursor(theUserInterface.myCursor);		if (theUserInterface.controlStripAvailable)	{		if (theUserInterface.controlStripUsed)	SBShowHideControlStrip(true);	}	// dispose of the gworlds	DisposeGWorld(theGWorlds.screenGWorld);	DisposeGWorld(theGWorlds.menuGWorld);	DisposeGWorld(theGWorlds.darwinGWorld);	DisposeGWorld(theGWorlds.safeGWorld);	DisposeGWorld(theGWorlds.itemGWorld);	DisposeGWorld(theGWorlds.platformGWorld);	DisposeGWorld(theGWorlds.hazardGWorld);	DisposeGWorld(theGWorlds.talismanGWorld);	DisposeGWorld(theGWorlds.parallaxBackGWorld);	for (i = 0; i < 8; i++) DisposeGWorld(theGWorlds.doorGWorld[i]);	// dispose of the prefs and high scores		DisposeHandle((Handle)gPrefs);	DisposeHandle((Handle)theScoreHandle);#ifndef DEMO	DisposeHandle((Handle)serialNumberHandle);#endif	DisposeRgn(theUserInterface.cursorRgn); theUserInterface.cursorRgn = 0; // make sure	ReleaseSounds();	CloseResFile(theFileStuff.GWDataFileNumber);		FlushEvents( keyDownMask + autoKeyMask, 0 );	// get rid of key presses			ShutdownHideMenuBar();	RestoreResolution();	ISpStop();// profiler#ifdef useProfiler	ProfilerDump("\pProfile");	ProfilerTerm();#endif}/* Event handling routine */void DoEvent(EventRecord *eventPtr){	char theChar;		switch (eventPtr->what)	{		case keyDown:		case autoKey:			if (!theUserInterface.gInBackGround)			{				theChar = eventPtr->message & charCodeMask;				if ((eventPtr->modifiers & cmdKey) != 0)				// need to do same as below with respect to hiding/showing of menu bar				HandleMenuChoice(MenuKey(theChar));			}			break;				case mouseDown:			if (!theUserInterface.gInBackGround)	HandleMouseDown(eventPtr);			break;				case updateEvt:			HandleUpdate(eventPtr);			break;					case osEvt:			HandleSuspendResume(eventPtr);			break;		case kHighLevelEvent:			AEProcessAppleEvent(eventPtr);			break;	}}/* suspend and resume events */void HandleSuspendResume(EventRecord *eventPtr){	if ((eventPtr->message & 0xFA000000) != 0)	{		//	must be a mouseMoved event			if (!theUserInterface.gInBackGround)	HandleMouseMoved(eventPtr->where);	}	else if ((eventPtr->message & suspendResumeMessage) == resumeFlag)	{		// resume				if (ChangeResolution() == false) FatalError("Resolution Switch Failed", false);				GetDefaultOutputVolume(&theAudioStuff.systemSoundVolume);		SetDefaultOutputVolume(0x01000100);		StartInterfaceMusic();		if (theUserInterface.controlStripUsed)	SBShowHideControlStrip(false);		SetupWindow();		DrawControlScreen(false);		HideTheMenuBar();		theUserInterface.gInBackGround = false;		SetCCursor(theUserInterface.myCursor);	}		else	{		// suspend event, so stop the music		StopInterfaceMusic();		SetDefaultOutputVolume(theAudioStuff.systemSoundVolume);		KillControls(theUserInterface.theWindow);		CloseWindow(theUserInterface.theWindow);		if (theUserInterface.blankingWindow) CloseWindow(theUserInterface.blankingWindow);		ShowTheMenuBar();		if (theUserInterface.controlStripUsed)	SBShowHideControlStrip(true);		SetCursor(&qd.arrow);		RestoreResolution();		theUserInterface.gInBackGround = true;	}	}/* tell the event manager that we are responding to the update event */void HandleUpdate(EventRecord *eventPtr){	WindowPtr	currentFrontWindow = (WindowPtr)eventPtr->message;	RgnHandle	theRegion;	Rect		tempRect;		BeginUpdate(currentFrontWindow);	if (currentFrontWindow == theUserInterface.theWindow)	{		theRegion = currentFrontWindow->visRgn;				ForeColor(blackColor);		BackColor(whiteColor);			tempRect.left = (**theRegion).rgnBBox.left;		tempRect.right = (**theRegion).rgnBBox.right;		tempRect.top = (**theRegion).rgnBBox.top;		tempRect.bottom = (**theRegion).rgnBBox.bottom;					CopyBits(  &((GrafPtr)theGWorlds.screenGWorld)->portBits, &((GrafPtr)(&theUserInterface.myCWindowRecord.port))->portBits,			&tempRect, &tempRect,  srcCopy, ( RgnHandle )0L );					UpdateControls(currentFrontWindow, theRegion);	}	else if (currentFrontWindow == theUserInterface.blankingWindow)	{		CGrafPtr	saved;		GDHandle	savedGD;			GetGWorld(&saved, &savedGD);		SetGWorld(&theUserInterface.blankingWindowRecord.port, GetMainDevice());			theRegion = currentFrontWindow->visRgn;				ForeColor(blackColor);		BackColor(whiteColor);			tempRect.left = (**theRegion).rgnBBox.left;		tempRect.right = (**theRegion).rgnBBox.right;		tempRect.top = (**theRegion).rgnBBox.top;		tempRect.bottom = (**theRegion).rgnBBox.bottom;				PaintRect(&tempRect);		SetGWorld(saved, savedGD);	}		EndUpdate(currentFrontWindow);}void HandleMouseDown(EventRecord *eventPtr){	short thePart;	WindowPtr whichWindow;	long menuChoice;	Point mousePoint;	ControlHandle theControl;		// if the mouse click is in the menu bar area, show the menu bar		CheckMenuHide(&eventPtr->where);		thePart = FindWindow (eventPtr->where, &whichWindow);		switch (thePart)	{		case inMenuBar:			// need to show the menu bar, draw it, then handle the menu choice			// hide the menu bar and update the relevant parts of the screen			menuChoice = MenuSelect(eventPtr->where);			HandleMenuChoice(menuChoice);			break;		case inSysWindow:			SystemClick(eventPtr, whichWindow);		case inContent:			mousePoint = eventPtr->where;			GlobalToLocal(&mousePoint);			thePart = FindControl(mousePoint, whichWindow, &theControl);			if (theControl)			{				PlayASound(sndClick);							if (!theUserInterface.gDialogInBox)				{										#ifdef DEMO					if (theControl == theUserInterface.registerInfoButton)					{						if (TrackControl(theControl, eventPtr->where, nil))						{							RegistrationInfoDialog();						}						break;					}					#else					if (theControl == theUserInterface.enterCodeButton)					{						if (TrackControl(theControl, eventPtr->where, nil))						{							RegisterDialog();						}						break;					}					#endif										else if (theControl == theUserInterface.newGameButton)					{						if (TrackControl(theControl, eventPtr->where, nil))	NewGame(nil);						break;					}					else if (theControl == theUserInterface.highScoresButton)					{						if (TrackControl(theControl, eventPtr->where, nil))						{							CustomHideCursor();							KillControls(theUserInterface.theWindow);							HighScoreEventLoop(false, 11);														CustomShowCursor();							DrawControlScreen(true);						}						break;					}					else if (theControl == theUserInterface.quitButton)					{						if (TrackControl(theControl, eventPtr->where, nil)) theUserInterface.gQuit = true;						}					else if (theControl == theUserInterface.soundButton)					{						if (TrackControl(theControl, eventPtr->where, nil))						{							SoundVolumeDialog();							UpdatePreferences();						}					}					else if (theControl == theUserInterface.musicButton)					{						if (TrackControl(theControl, eventPtr->where, nil))						{							MusicVolumeDialog();							UpdatePreferences();						}					}					else if (theControl == theUserInterface.controlsButton)					{						if (TrackControl(theControl, eventPtr->where, nil))							ISpConfigure(nil);							SetCCursor(theUserInterface.myCursor);					}					else if (theControl == theUserInterface.helpButton)					{						if (TrackControl(theControl, eventPtr->where, nil))						{							CustomHideCursor();							KillControls(theUserInterface.theWindow);							HelpScreen();														DrawControlScreen(true);						}					}				}				else				{				}			}			break;	}	}void HandleMouseMoved(Point mousePoint){	short thePart;	ControlHandle theControl;		GlobalToLocal(&mousePoint);	thePart = FindControl(mousePoint, theUserInterface.theWindow, &theControl);	if (theControl)	{		// moved into a control			SetControlReference(theUserInterface.newGameButton, 0);		SetControlReference(theUserInterface.highScoresButton, 0);		SetControlReference(theUserInterface.quitButton, 0);		SetControlReference(theUserInterface.controlsButton, 0);		SetControlReference(theUserInterface.helpButton, 0);		SetControlReference(theUserInterface.musicButton, 0);		SetControlReference(theUserInterface.soundButton, 0);				#ifdef	DEMO		if (theUserInterface.registerInfoButton) SetControlReference(theUserInterface.registerInfoButton, 0);		#else		if (theUserInterface.enterCodeButton) SetControlReference(theUserInterface.enterCodeButton, 0);		#endif		// now hilight the control under the mouse and update all				SetControlReference(theControl, 2);		UpdateControls(theUserInterface.theWindow, theUserInterface.theWindow->visRgn);				// the new mouse region needs to be the controls rect		RectRgn(theUserInterface.cursorRgn, &(*theControl)->contrlRect);	}	else	{		// moved out of a control			SetControlReference(theUserInterface.newGameButton, 0);		SetControlReference(theUserInterface.highScoresButton, 0);		SetControlReference(theUserInterface.quitButton, 0);		SetControlReference(theUserInterface.controlsButton, 0);		SetControlReference(theUserInterface.helpButton, 0);		SetControlReference(theUserInterface.musicButton, 0);		SetControlReference(theUserInterface.soundButton, 0);				#ifdef	DEMO		if (theUserInterface.registerInfoButton) SetControlReference(theUserInterface.registerInfoButton, 0);		#else		if (theUserInterface.enterCodeButton) SetControlReference(theUserInterface.enterCodeButton, 0);		#endif				// now update the controls				UpdateControls(theUserInterface.theWindow, theUserInterface.theWindow->visRgn);				// the region now needs to be the default		SetupRgn();	}}#ifndef	DEMOpascal OSErr HandleOpenDocAE(const AppleEvent *theAEvent, AppleEvent *, long ){	OSErr		error = noErr, firstError = noErr;	short		numErrors = 0;	AEDesc		theList;	long		numFiles;	/* the direct object parameter is the list of aliases to files (one or more) */	error = AEGetParamDesc(theAEvent, keyDirectObject, typeAEList, &theList);	if (error)	{		return(error);	}/* that should be all, but in case something is screwy... *//*	error = EasyHasUnusedParameters(theAEvent);	if (error)	{		return(error);	}*//* get number of files in list */	error = AECountItems(&theList, &numFiles);	if (error)	{		return(error);	}		if (numFiles > 1)	{		// don't know which to open	}	else	{		FSSpec		fileToOpen;		long		actualSize;		AEKeyword	dummyKeyword;		DescType	dummyType;		WindowPtr	newWindow = nil;				/* get the alias for the nth file, convert to an FSSpec */		error = AEGetNthPtr(&theList, 1, typeFSS, &dummyKeyword, &dummyType, 								(Ptr) &fileToOpen, sizeof(FSSpec), &actualSize);		if (error)		{			return(error);		}		// a file was selected, so check what to do			NewGame(&fileToOpen);	}		AEDisposeDesc(&theList); /* dispose what we allocated */	return(error);}#endifvoid	FlashFadeIn(void){	short	i;	Rect	tempRect, destRect;	unsigned long	timer;		SetRect(&destRect, 0, 0, 640, 480);		for (i = 1; i < 17; i++)	{		timer = TickCount();		tempRect.left = 320 - (20 * i);		tempRect.right = 320 + (20 * i);		tempRect.top = 240 - (15 * i);		tempRect.bottom = 240 + (15 * i);				CopyBits(&((GrafPtr)theGWorlds.screenGWorld)->portBits, &((GrafPtr)(&theUserInterface.myCWindowRecord.port))->portBits,		&tempRect, &destRect,  srcCopy, ( RgnHandle )0L );			while (timer > (TickCount() - 2)) {}	}}